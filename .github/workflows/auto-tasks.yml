name: Auto Tasks

# Scheduled daily at midnight AEDT on main (production).
# Can also be triggered manually on test or main (workflow_dispatch).
# Note: update cron to '0 14 * * *' during AEST (UTC+10, non-daylight-saving).
#
# Branch → Environment:
#   main  →  production  (scheduled + manual)
#   test  →  test        (manual only)
#
# Merge prerequisites for manual triggers (enforced by verify-merge job):
#   test branch  — a feature branch must be merged into test before triggering
#   main branch  — test branch must be merged into main before triggering
# Scheduled runs bypass the merge gate (they always execute on main).

on:
  schedule:
    - cron: '0 13 * * *'    # 00:00 AEDT (UTC+11)
  workflow_dispatch:

env:
  # Bump this value (e.g. v2, v3) to force a fresh PowerShell module install.
  PS_MODULE_CACHE_KEY: v1

jobs:
  verify-merge:
    name: Verify merge prerequisite (${{ github.ref_name }})
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0        # full history required for ancestry checks

      - name: Check merge prerequisite
        run: |
          BRANCH="${{ github.ref_name }}"

          if [ "$BRANCH" = "main" ]; then
            echo "Branch: main → verifying test is fully merged into main..."
            git fetch origin test
            if git merge-base --is-ancestor origin/test HEAD; then
              echo "✅ test is merged into main — production run authorised."
            else
              echo "❌ test has commits not present in main."
              echo "   Open a PR to merge test → main and complete it before triggering the production workflow."
              exit 1
            fi
          else
            echo "Branch: $BRANCH → verifying feature work is present (test is ahead of main)..."
            git fetch origin main
            AHEAD=$(git rev-list --count origin/main..HEAD)
            if [ "$AHEAD" -gt 0 ]; then
              echo "✅ $BRANCH is $AHEAD commit(s) ahead of main — test run authorised."
            else
              echo "❌ $BRANCH has no new commits ahead of main."
              echo "   Merge a feature branch into test before triggering the test workflow."
              exit 1
            fi
          fi

  birthright:
    name: Birthright ${{ matrix.group }} on ${{ github.ref_name }}
    needs: verify-merge
    # Run when: verify-merge succeeded (workflow_dispatch) OR was skipped (schedule).
    # if: always() prevents GitHub from auto-skipping this job when verify-merge is skipped.
    if: always() && (needs.verify-merge.result == 'success' || needs.verify-merge.result == 'skipped')
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'production' || 'test' }}
    strategy:
      fail-fast: false    # run both groups even if one fails
      matrix:
        group: [group1, group2]

    steps:
      - uses: actions/checkout@v4

      - name: Cache PowerShell modules
        id: ps-module-cache
        uses: actions/cache@v4
        with:
          path: ~/.local/share/powershell/Modules
          key: ps-modules-${{ env.PS_MODULE_CACHE_KEY }}

      - name: Install Microsoft Entra PowerShell
        if: steps.ps-module-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: Install-Module Microsoft.Entra -Force -AllowClobber -Scope CurrentUser

      - name: Run birthright ${{ matrix.group }}
        shell: pwsh
        env:
          TENANT_ID:            ${{ secrets.TENANT_ID }}
          CLIENT_ID:            ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET:        ${{ secrets.CLIENT_SECRET }}
          BIRTHRIGHT_GROUP1_ID: ${{ secrets.BIRTHRIGHT_GROUP1_ID }}
          BIRTHRIGHT_GROUP2_ID: ${{ secrets.BIRTHRIGHT_GROUP2_ID }}
        run: |
          $envLabel = if ('${{ github.ref_name }}' -eq 'main') { 'Prod' } else { 'Test' }
          $groupId  = if ('${{ matrix.group }}' -eq 'group1') { $env:BIRTHRIGHT_GROUP1_ID } else { $env:BIRTHRIGHT_GROUP2_ID }
          $logFile  = "logs/$envLabel/birthright-${{ matrix.group }}_run${{ github.run_number }}.log"
          $params   = @{
            Environment  = $envLabel
            TenantId     = $env:TENANT_ID
            ClientId     = $env:CLIENT_ID
            ClientSecret = $env:CLIENT_SECRET
            GroupId      = $groupId
            LogFile      = $logFile
          }
          ./scripts/auto-tasks/Add-BirthrightMembers.ps1 @params

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: birthright-${{ matrix.group }}_${{ github.ref_name }}_run${{ github.run_number }}
          path: logs/
          retention-days: 90
